<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Three Neat Things I Did With Julia | systems++</title>
<meta name=keywords content="programming,julia">
<meta name=description content="In the past, I&rsquo;ve written pretty glowingly about Julia. It&rsquo;s been a few years since I first used Julia in 2019, and it hasn&rsquo;t completely replaced Python for me. However, I wanted to share a few neat projects that I&rsquo;ve done using it which would have been much more painful without it, and share what I think now about what I wrote in 2019.
Implementing a Statistical Metric on the GPU Being able to access heterogenous compute is important to be able to make the most of the availible hardware.">
<meta name=author content="Robert Underwood">
<link rel=canonical href=http://robertu94.github.io/2022/12/15/three-neat-things-i-did-with-julia.html>
<meta name=google-site-verification content="G-9KQE44SX6K">
<link crossorigin=anonymous href=/assets/css/stylesheet.57f29198e62b3a8f07d37acaca0427bafb684416046b823f5a616bd858bb4af1.css integrity="sha256-V/KRmOYrOo8H03rKygQnuvtoRBYEa4I/WmFr2Fi7SvE=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.baa4f2053c75d0009e9309aae8f8a8959f5e0372e88f80cdf2951a9533d71ce2.js integrity="sha256-uqTyBTx10ACekwmq6PiolZ9eA3Loj4DN8pUalTPXHOI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://robertu94.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=http://robertu94.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=http://robertu94.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=http://robertu94.github.io/apple-touch-icon.png>
<link rel=mask-icon href=http://robertu94.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9KQE44SX6K"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-9KQE44SX6K',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Three Neat Things I Did With Julia">
<meta property="og:description" content="In the past, I&rsquo;ve written pretty glowingly about Julia. It&rsquo;s been a few years since I first used Julia in 2019, and it hasn&rsquo;t completely replaced Python for me. However, I wanted to share a few neat projects that I&rsquo;ve done using it which would have been much more painful without it, and share what I think now about what I wrote in 2019.
Implementing a Statistical Metric on the GPU Being able to access heterogenous compute is important to be able to make the most of the availible hardware.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://robertu94.github.io/2022/12/15/three-neat-things-i-did-with-julia.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-12-15T00:00:00+00:00">
<meta property="article:modified_time" content="2022-12-15T00:00:00+00:00"><meta property="og:site_name" content="Systems++">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Three Neat Things I Did With Julia">
<meta name=twitter:description content="In the past, I&rsquo;ve written pretty glowingly about Julia. It&rsquo;s been a few years since I first used Julia in 2019, and it hasn&rsquo;t completely replaced Python for me. However, I wanted to share a few neat projects that I&rsquo;ve done using it which would have been much more painful without it, and share what I think now about what I wrote in 2019.
Implementing a Statistical Metric on the GPU Being able to access heterogenous compute is important to be able to make the most of the availible hardware.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Three Neat Things I Did With Julia","item":"http://robertu94.github.io/2022/12/15/three-neat-things-i-did-with-julia.html"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Three Neat Things I Did With Julia","name":"Three Neat Things I Did With Julia","description":"In the past, I\u0026rsquo;ve written pretty glowingly about Julia. It\u0026rsquo;s been a few years since I first used Julia in 2019, and it hasn\u0026rsquo;t completely replaced Python for me. However, I wanted to share a few neat projects that I\u0026rsquo;ve done using it which would have been much more painful without it, and share what I think now about what I wrote in 2019.\nImplementing a Statistical Metric on the GPU Being able to access heterogenous compute is important to be able to make the most of the availible hardware.","keywords":["programming","julia"],"articleBody":"In the past, I’ve written pretty glowingly about Julia. It’s been a few years since I first used Julia in 2019, and it hasn’t completely replaced Python for me. However, I wanted to share a few neat projects that I’ve done using it which would have been much more painful without it, and share what I think now about what I wrote in 2019.\nImplementing a Statistical Metric on the GPU Being able to access heterogenous compute is important to be able to make the most of the availible hardware. Doing so almost always requiring jumping to another (often device specific) language to implmenet a mix of kenrels and high-level reductions. While Julia doesn’t allow you to completely get away from device specific code for more than simple cases (for now), it does give you an easy way to mix high level reductions and low-level kernels to run on the GPU.\nThis code computes a metric that I call the quantized entropy which highlights each of Julia’s capabilities here:\n We can easily define a kernel – even one that uses more advanced kernel features like atomics Writing reductions – even reductions that aren’t provided upstream – is really easy Many operations (i.e. BLAS/LaPACK operations) just work and are applied on the GPU just by casting to a device array type.  This code is pretty concise 40 lines of code. I implemented another metric that uses Multi-GPU capabilies that 36 lines of code and leveraged linear algebra capabilities of the native device libraries which is remarkably consise.\nusing CUDA function quantize_kernel(cu_data, global_bins, N::Int64, dmin::Float32, abs::Float32) global_idx = threadIdx().x + blockDim().x * (blockIdx().x -1) if global_idx  N bin_idx = trunc(Int32,(cu_data[global_idx] - dmin)/abs) + 1 @inbounds CUDA.@atomic global_bins[bin_idx] += 1 end return end function extreem(x:: Tuple{T,T}, y:: T)::Tuple{T,T} where{T} (min_x, max_x) = x; return (min(min_x, y), max(max_x, y)) end function extreem(x:: T, y:: Tuple{T,T})::Tuple{T,T} where{T} (min_y, max_y) = y; return (min(x, min_y), max(x, max_y)) end function extreem(x:: Tuple{T,T}, y:: Tuple{T,T})::Tuple{T,T} where{T} (min_x, max_x) = x; (min_y, max_y) = y; return (min(min_x, min_y), max(max_x, max_y)) end GPUArrays.neutral_element(::typeof(extreem), T) = (floatmax(T), floatmin(T)) function cuda_qentropy(data; abs=1e-4) cu_data = CuArray(data); N = length(cu_data) (dmin,dmax) = reduce(extreem, cu_data; init=(floatmax(eltype(data)),floatmin(eltype(data)))) bin_counts = round(Int64,(dmax-dmin)/abs) + 1 bins = CUDA.zeros(Int32, bin_counts) n_threads=32 n_blocks=trunc(Int,(N + n_threads+1) / n_threads) @cuda threads=n_threads blocks=n_blocks quantize_kernel(cu_data, bins, N, dmin, abs) -mapreduce(+, bins; init=0.0) do bin if bin != 0 prop = convert(Float64,bin)/N; prop * log2(prop) else 0.0 end end end Implmenting an Interactive Visualization of Slices of 3D Data. Understanding how data is structured is much easier with interactive tools, but depending on what structure you are looking for, there aren’t always pre-built tools that will help you understand that strucuture. I’ve consistently been frustrated with the apparent inconsistencies of tools like matplotlib, and I was impressed with what I could build in just a few lines of code.\nThis code highlights\n How to apply layouts and multiple figure types with ease How to easily make them interactive via reactive programming. How to incorperate keyboard interactivity  This is 36 lines of code creates an interactive visualization that shows both a histogram and heatmap of slices of 3d data that can be updated with either a slider or with keyboard commands.\nusing GLMakie function vis_explorer(args::SliceExploreArguments) data = Array{args.type}(undef, args.dims...) read!(args.filename, data) n_slices = args.dims[end] min,max = extrema(data) fig = Figure() s = Slider(fig[2,1:2], range=1:1:n_slices, startvalue=round(Int,args.dims[end]/2)) slice = lift(s.value) do v data[:,:, v] end slice_vec = lift(s.value) do v vec(data[:,:, v]) end hist_title = lift(s.value) do v \"Histogram slice $v\" end img_title = lift(s.value) do v \"SliceView slice $v\" end hist_ax = Axis(fig[1,1], title=hist_title, limits=((min,max), nothing)) hist!(hist_ax, slice_vec) img_ax = Axis(fig[1,2], title=img_title) hm = heatmap!(img_ax, slice) Colorbar(fig[:,end+1], hm) on(events(fig).keyboardbutton) do event if event.action == Keyboard.press || event.action == Keyboard.repeat if event.key == Keyboard.k set_close_to!(s, s.value[]+1) elseif event.key == Keyboard.j set_close_to!(s, s.value[]-1) end end end fig end Implementing a Distributed Experiment Writing experiments that spans several nodes is the bread and butter of writing code in HPC. While it is possible to use libraries such as mpi4py or libdistributed to write experiments that run on any nodes, Julia provides a set of libraries that make this nearly effortless, and many of them are part of the standard library.\nIn this code you can see:\n A distributed for loop where communications between nodes were serialized and abstracted away The ability to distribute libraries and data to all nodes with the @everwhere macro A simple way to store complex metrics to standard formats like CSV even when not all experiments return the same keys  And all of this comes in a mere 36 lines of code.\nusing Distributed using Base.Iterators addprocs(6) template = Array{Float32}(undef, 500, 500, 100) read!(expanduser(\"~/git/datasets/hurricane/100x500x500/CLOUDf48.bin.f32\"), template) # broadcast libraries and data to workers @everywhere using Pressio @everywhere input_data = $template @everywhere library = pressio() configurations = collect((product([\"sz\", \"zfp\"], exp10.(range(-1, -6, length=6))))) results = @sync @distributed vcat for (comp_id, abs) in configurations try comp = compressor(library, comp_id) options = Dict{String,Any}( \"pressio:abs\" = abs, \"pressio:metric\" = \"size\", ) set_options(comp, options) compress(comp, input_data) result = get_metrics_results(comp) result[\"error\"] = missing catch e result = Dict{String, Any}() result[\"error\"] = e end result[\"comp_id\"] = comp_id result[\"abs\"] = abs [result] end using DataFrames, Tables, CSV CSV.write(\"/tmp/results.csv\", Tables.dictcolumntable(results), transform=((col, val) - something(val, missing))) What Are My Thoughts Since 2019? I largely stand by my 2019 review. The good things about Julia are still good, and if not have gotten better. While, I still find the matlabisms annoying, I eventually learned enougth of them to be productive. However, the package ecosystem has matured substantially in just 2 years with libraries especially in the areas of language interpop, accllerated computing, and mathmatical computing are now among best in class, but other areas still are lacking. I even think discoverablity has improved with podcasts (although mostly on hiatus) like Talk Julia and the Julia Bloggers and Julia Conn online pressenece improving knowledge of what is being developed in the Julia community. However discoverablity of what function to use could still be improved, but has gotten better with things like LanguageServer.jl.\nHowever, I think 3 things are still largely keeping me from using it more:\n Reliance on specific Python or C++ libraries. If a project is 90% relying on a library in some other langauge (i.e. Tensorflow/PyTorch, libfabric) it sometimes makes sense to just use that language. Finding Julia based alternatives takes time, and isn’t always worth the effort Lack of knowledge among my colleagues. A big part of my work is sharing my code with others, and many of my coleagues don’t use Julia. Although for some packages, it has gotten way better, some packages still have really long pre-compile times (i.e. time to first plot).  Hope this helps!\n","wordCount":"1111","inLanguage":"en","datePublished":"2022-12-15T00:00:00Z","dateModified":"2022-12-15T00:00:00Z","author":{"@type":"Person","name":"Robert Underwood"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://robertu94.github.io/2022/12/15/three-neat-things-i-did-with-julia.html"},"publisher":{"@type":"Organization","name":"systems++","logo":{"@type":"ImageObject","url":"http://robertu94.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=http://robertu94.github.io/ accesskey=h title="systems++ (Alt + H)">systems++</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=http://robertu94.github.io/about.html title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/guides.html title=Guides>
<span>Guides</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/learning.html title="Learning To Learn">
<span>Learning To Learn</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/presentations.html title=Presentations>
<span>Presentations</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=http://robertu94.github.io/>Home</a></div>
<h1 class=post-title>
Three Neat Things I Did With Julia
</h1>
<div class=post-meta><span title="2022-12-15 00:00:00 +0000 UTC">December 15, 2022</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1111 words&nbsp;·&nbsp;Robert Underwood
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><nav id=TableOfContents>
<ul>
<li><a href=#implementing-a-statistical-metric-on-the-gpu>Implementing a Statistical Metric on the GPU</a></li>
<li><a href=#implmenting-an-interactive-visualization-of-slices-of-3d-data>Implmenting an Interactive Visualization of Slices of 3D Data.</a></li>
<li><a href=#implementing-a-distributed-experiment>Implementing a Distributed Experiment</a></li>
<li><a href=#what-are-my-thoughts-since-2019>What Are My Thoughts Since 2019?</a></li>
</ul>
</nav>
</div>
</details>
</div>
<div class=post-content><p>In the past, I&rsquo;ve <a href=http://robertu94.github.io/2019/04/04/julia-could-there-be-one-language.html>written pretty glowingly about Julia</a>. It&rsquo;s been a few years
since I first used Julia in 2019, and it hasn&rsquo;t completely replaced Python for
me. However, I wanted to share a few neat projects that I&rsquo;ve done using it
which would have been much more painful without it, and share what I think now
about what I wrote in 2019.</p>
<h1 id=implementing-a-statistical-metric-on-the-gpu>Implementing a Statistical Metric on the GPU<a hidden class=anchor aria-hidden=true href=#implementing-a-statistical-metric-on-the-gpu>#</a></h1>
<p>Being able to access heterogenous compute is important to be able to make the
most of the availible hardware. Doing so almost always requiring jumping to
another (often device specific) language to implmenet a mix of kenrels and
high-level reductions. While Julia doesn&rsquo;t allow you to completely get away
from device specific code for more than simple cases (<a href=https://juliagpu.github.io/KernelAbstractions.jl/stable/>for
now</a>), it does give
you an easy way to mix high level reductions and low-level kernels to run on
the GPU.</p>
<p>This code computes a metric that I call the quantized entropy which highlights
each of Julia&rsquo;s capabilities here:</p>
<ol>
<li>We can easily define a kernel &ndash; even one that uses more advanced kernel
features like atomics</li>
<li>Writing reductions &ndash; even reductions that aren&rsquo;t provided upstream &ndash; is
really easy</li>
<li>Many operations (i.e. BLAS/LaPACK operations) just work and are applied on
the GPU just by casting to a device array type.</li>
</ol>
<p>This code is pretty concise 40 lines of code. I implemented another metric
that uses Multi-GPU capabilies that 36 lines of code and leveraged linear
algebra capabilities of the native device libraries which is remarkably consise.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-julia data-lang=julia><span class=k>using</span> <span class=n>CUDA</span>
<span class=k>function</span> <span class=n>quantize_kernel</span><span class=p>(</span><span class=n>cu_data</span><span class=p>,</span> <span class=n>global_bins</span><span class=p>,</span> <span class=n>N</span><span class=o>::</span><span class=kt>Int64</span><span class=p>,</span> <span class=n>dmin</span><span class=o>::</span><span class=kt>Float32</span><span class=p>,</span> <span class=n>abs</span><span class=o>::</span><span class=kt>Float32</span><span class=p>)</span>
  <span class=n>global_idx</span> <span class=o>=</span> <span class=n>threadIdx</span><span class=p>()</span><span class=o>.</span><span class=n>x</span> <span class=o>+</span> <span class=n>blockDim</span><span class=p>()</span><span class=o>.</span><span class=n>x</span> <span class=o>*</span> <span class=p>(</span><span class=n>blockIdx</span><span class=p>()</span><span class=o>.</span><span class=n>x</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
  <span class=k>if</span> <span class=n>global_idx</span> <span class=o>&lt;=</span> <span class=n>N</span>
    <span class=n>bin_idx</span> <span class=o>=</span> <span class=n>trunc</span><span class=p>(</span><span class=kt>Int32</span><span class=p>,(</span><span class=n>cu_data</span><span class=p>[</span><span class=n>global_idx</span><span class=p>]</span> <span class=o>-</span> <span class=n>dmin</span><span class=p>)</span><span class=o>/</span><span class=n>abs</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
    <span class=nd>@inbounds</span> <span class=n>CUDA</span><span class=o>.</span><span class=nd>@atomic</span> <span class=n>global_bins</span><span class=p>[</span><span class=n>bin_idx</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
  <span class=k>end</span>
  <span class=k>return</span>
<span class=k>end</span>
<span class=k>function</span> <span class=n>extreem</span><span class=p>(</span><span class=n>x</span><span class=o>::</span> <span class=kt>Tuple</span><span class=p>{</span><span class=kt>T</span><span class=p>,</span><span class=kt>T</span><span class=p>},</span> <span class=n>y</span><span class=o>::</span> <span class=n>T</span><span class=p>)</span><span class=o>::</span><span class=kt>Tuple</span><span class=p>{</span><span class=kt>T</span><span class=p>,</span><span class=kt>T</span><span class=p>}</span> <span class=kt>where</span><span class=p>{</span><span class=kt>T</span><span class=p>}</span>
  <span class=p>(</span><span class=n>min_x</span><span class=p>,</span> <span class=n>max_x</span><span class=p>)</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
  <span class=k>return</span> <span class=p>(</span><span class=n>min</span><span class=p>(</span><span class=n>min_x</span><span class=p>,</span> <span class=n>y</span><span class=p>),</span> <span class=n>max</span><span class=p>(</span><span class=n>max_x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>
<span class=k>end</span>
<span class=k>function</span> <span class=n>extreem</span><span class=p>(</span><span class=n>x</span><span class=o>::</span> <span class=n>T</span><span class=p>,</span> <span class=n>y</span><span class=o>::</span> <span class=kt>Tuple</span><span class=p>{</span><span class=kt>T</span><span class=p>,</span><span class=kt>T</span><span class=p>})</span><span class=o>::</span><span class=kt>Tuple</span><span class=p>{</span><span class=kt>T</span><span class=p>,</span><span class=kt>T</span><span class=p>}</span> <span class=kt>where</span><span class=p>{</span><span class=kt>T</span><span class=p>}</span>
  <span class=p>(</span><span class=n>min_y</span><span class=p>,</span> <span class=n>max_y</span><span class=p>)</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>
  <span class=k>return</span> <span class=p>(</span><span class=n>min</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>min_y</span><span class=p>),</span> <span class=n>max</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>max_y</span><span class=p>))</span>
<span class=k>end</span>
<span class=k>function</span> <span class=n>extreem</span><span class=p>(</span><span class=n>x</span><span class=o>::</span> <span class=kt>Tuple</span><span class=p>{</span><span class=kt>T</span><span class=p>,</span><span class=kt>T</span><span class=p>},</span> <span class=n>y</span><span class=o>::</span> <span class=kt>Tuple</span><span class=p>{</span><span class=kt>T</span><span class=p>,</span><span class=kt>T</span><span class=p>})</span><span class=o>::</span><span class=kt>Tuple</span><span class=p>{</span><span class=kt>T</span><span class=p>,</span><span class=kt>T</span><span class=p>}</span> <span class=kt>where</span><span class=p>{</span><span class=kt>T</span><span class=p>}</span>
  <span class=p>(</span><span class=n>min_x</span><span class=p>,</span> <span class=n>max_x</span><span class=p>)</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
  <span class=p>(</span><span class=n>min_y</span><span class=p>,</span> <span class=n>max_y</span><span class=p>)</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>
  <span class=k>return</span> <span class=p>(</span><span class=n>min</span><span class=p>(</span><span class=n>min_x</span><span class=p>,</span> <span class=n>min_y</span><span class=p>),</span> <span class=n>max</span><span class=p>(</span><span class=n>max_x</span><span class=p>,</span> <span class=n>max_y</span><span class=p>))</span>
<span class=k>end</span>
<span class=n>GPUArrays</span><span class=o>.</span><span class=n>neutral_element</span><span class=p>(</span><span class=o>::</span><span class=n>typeof</span><span class=p>(</span><span class=n>extreem</span><span class=p>),</span> <span class=n>T</span><span class=p>)</span> <span class=o>=</span> <span class=p>(</span><span class=n>floatmax</span><span class=p>(</span><span class=n>T</span><span class=p>),</span> <span class=n>floatmin</span><span class=p>(</span><span class=n>T</span><span class=p>))</span>
<span class=k>function</span> <span class=n>cuda_qentropy</span><span class=p>(</span><span class=n>data</span><span class=p>;</span> <span class=n>abs</span><span class=o>=</span><span class=mf>1e-4</span><span class=p>)</span>
  <span class=n>cu_data</span> <span class=o>=</span> <span class=n>CuArray</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
  <span class=n>N</span> <span class=o>=</span> <span class=n>length</span><span class=p>(</span><span class=n>cu_data</span><span class=p>)</span>
  <span class=p>(</span><span class=n>dmin</span><span class=p>,</span><span class=n>dmax</span><span class=p>)</span> <span class=o>=</span> <span class=n>reduce</span><span class=p>(</span><span class=n>extreem</span><span class=p>,</span> <span class=n>cu_data</span><span class=p>;</span> <span class=n>init</span><span class=o>=</span><span class=p>(</span><span class=n>floatmax</span><span class=p>(</span><span class=n>eltype</span><span class=p>(</span><span class=n>data</span><span class=p>)),</span><span class=n>floatmin</span><span class=p>(</span><span class=n>eltype</span><span class=p>(</span><span class=n>data</span><span class=p>))))</span>
  <span class=n>bin_counts</span> <span class=o>=</span> <span class=n>round</span><span class=p>(</span><span class=kt>Int64</span><span class=p>,(</span><span class=n>dmax</span><span class=o>-</span><span class=n>dmin</span><span class=p>)</span><span class=o>/</span><span class=n>abs</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
  <span class=n>bins</span> <span class=o>=</span> <span class=n>CUDA</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=kt>Int32</span><span class=p>,</span> <span class=n>bin_counts</span><span class=p>)</span>
  <span class=n>n_threads</span><span class=o>=</span><span class=mi>32</span>
  <span class=n>n_blocks</span><span class=o>=</span><span class=n>trunc</span><span class=p>(</span><span class=kt>Int</span><span class=p>,(</span><span class=n>N</span> <span class=o>+</span> <span class=n>n_threads</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>n_threads</span><span class=p>)</span>
  <span class=nd>@cuda</span> <span class=n>threads</span><span class=o>=</span><span class=n>n_threads</span> <span class=n>blocks</span><span class=o>=</span><span class=n>n_blocks</span> <span class=n>quantize_kernel</span><span class=p>(</span><span class=n>cu_data</span><span class=p>,</span> <span class=n>bins</span><span class=p>,</span> <span class=n>N</span><span class=p>,</span> <span class=n>dmin</span><span class=p>,</span> <span class=n>abs</span><span class=p>)</span>
  <span class=o>-</span><span class=n>mapreduce</span><span class=p>(</span><span class=o>+</span><span class=p>,</span> <span class=n>bins</span><span class=p>;</span> <span class=n>init</span><span class=o>=</span><span class=mf>0.0</span><span class=p>)</span> <span class=k>do</span> <span class=n>bin</span>
    <span class=k>if</span> <span class=n>bin</span> <span class=o>!=</span> <span class=mi>0</span>
      <span class=n>prop</span> <span class=o>=</span> <span class=n>convert</span><span class=p>(</span><span class=kt>Float64</span><span class=p>,</span><span class=n>bin</span><span class=p>)</span><span class=o>/</span><span class=n>N</span><span class=p>;</span>
      <span class=n>prop</span> <span class=o>*</span> <span class=n>log2</span><span class=p>(</span><span class=n>prop</span><span class=p>)</span>
    <span class=k>else</span>
      <span class=mf>0.0</span>
    <span class=k>end</span>
  <span class=k>end</span>
<span class=k>end</span>
</code></pre></div><h1 id=implmenting-an-interactive-visualization-of-slices-of-3d-data>Implmenting an Interactive Visualization of Slices of 3D Data.<a hidden class=anchor aria-hidden=true href=#implmenting-an-interactive-visualization-of-slices-of-3d-data>#</a></h1>
<p>Understanding how data is structured is much easier with interactive tools, but
depending on what structure you are looking for, there aren&rsquo;t always pre-built tools
that will help you understand that strucuture. I&rsquo;ve consistently been frustrated with
the apparent inconsistencies of tools like <code>matplotlib</code>, and I was impressed with what
I could build in just a few lines of code.</p>
<p>This code highlights</p>
<ol>
<li>How to apply layouts and multiple figure types with ease</li>
<li>How to easily make them interactive via reactive programming.</li>
<li>How to incorperate keyboard interactivity</li>
</ol>
<p>This is 36 lines of code creates an interactive visualization that shows both a
histogram and heatmap of slices of 3d data that can be updated with either a slider
or with keyboard commands.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-julia data-lang=julia><span class=k>using</span> <span class=n>GLMakie</span>
<span class=k>function</span> <span class=n>vis_explorer</span><span class=p>(</span><span class=n>args</span><span class=o>::</span><span class=kt>SliceExploreArguments</span><span class=p>)</span>
    <span class=n>data</span> <span class=o>=</span> <span class=kt>Array</span><span class=p>{</span><span class=kt>args</span><span class=o>.</span><span class=kt>type</span><span class=p>}(</span><span class=nb>undef</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>dims</span><span class=o>...</span><span class=p>)</span>
    <span class=n>read!</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>filename</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
    <span class=n>n_slices</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>dims</span><span class=p>[</span><span class=k>end</span><span class=p>]</span>
    <span class=n>min</span><span class=p>,</span><span class=n>max</span> <span class=o>=</span> <span class=n>extrema</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
    <span class=n>fig</span> <span class=o>=</span> <span class=n>Figure</span><span class=p>()</span>
    <span class=n>s</span> <span class=o>=</span> <span class=n>Slider</span><span class=p>(</span><span class=n>fig</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=o>:</span><span class=mi>2</span><span class=p>],</span> <span class=n>range</span><span class=o>=</span><span class=mi>1</span><span class=o>:</span><span class=mi>1</span><span class=o>:</span><span class=n>n_slices</span><span class=p>,</span> <span class=n>startvalue</span><span class=o>=</span><span class=n>round</span><span class=p>(</span><span class=kt>Int</span><span class=p>,</span><span class=n>args</span><span class=o>.</span><span class=n>dims</span><span class=p>[</span><span class=k>end</span><span class=p>]</span><span class=o>/</span><span class=mi>2</span><span class=p>))</span>
    <span class=n>slice</span> <span class=o>=</span> <span class=n>lift</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>value</span><span class=p>)</span> <span class=k>do</span> <span class=n>v</span>
        <span class=n>data</span><span class=p>[</span><span class=o>:</span><span class=p>,</span><span class=o>:</span><span class=p>,</span> <span class=n>v</span><span class=p>]</span>
    <span class=k>end</span>
    <span class=n>slice_vec</span> <span class=o>=</span> <span class=n>lift</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>value</span><span class=p>)</span> <span class=k>do</span> <span class=n>v</span>
        <span class=n>vec</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=o>:</span><span class=p>,</span><span class=o>:</span><span class=p>,</span> <span class=n>v</span><span class=p>])</span>
    <span class=k>end</span>
    <span class=n>hist_title</span> <span class=o>=</span> <span class=n>lift</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>value</span><span class=p>)</span> <span class=k>do</span> <span class=n>v</span>
        <span class=s>&#34;Histogram slice </span><span class=si>$v</span><span class=s>&#34;</span>
    <span class=k>end</span>
    <span class=n>img_title</span> <span class=o>=</span> <span class=n>lift</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>value</span><span class=p>)</span> <span class=k>do</span> <span class=n>v</span>
        <span class=s>&#34;SliceView slice </span><span class=si>$v</span><span class=s>&#34;</span>
    <span class=k>end</span>
    <span class=n>hist_ax</span> <span class=o>=</span> <span class=n>Axis</span><span class=p>(</span><span class=n>fig</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>],</span> <span class=n>title</span><span class=o>=</span><span class=n>hist_title</span><span class=p>,</span> <span class=n>limits</span><span class=o>=</span><span class=p>((</span><span class=n>min</span><span class=p>,</span><span class=n>max</span><span class=p>),</span> <span class=nb>nothing</span><span class=p>))</span>
    <span class=n>hist!</span><span class=p>(</span><span class=n>hist_ax</span><span class=p>,</span> <span class=n>slice_vec</span><span class=p>)</span>
    <span class=n>img_ax</span> <span class=o>=</span> <span class=n>Axis</span><span class=p>(</span><span class=n>fig</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>],</span> <span class=n>title</span><span class=o>=</span><span class=n>img_title</span><span class=p>)</span>
    <span class=n>hm</span> <span class=o>=</span> <span class=n>heatmap!</span><span class=p>(</span><span class=n>img_ax</span><span class=p>,</span> <span class=n>slice</span><span class=p>)</span>
    <span class=n>Colorbar</span><span class=p>(</span><span class=n>fig</span><span class=p>[</span><span class=o>:</span><span class=p>,</span><span class=k>end</span><span class=o>+</span><span class=mi>1</span><span class=p>],</span> <span class=n>hm</span><span class=p>)</span>

    <span class=n>on</span><span class=p>(</span><span class=n>events</span><span class=p>(</span><span class=n>fig</span><span class=p>)</span><span class=o>.</span><span class=n>keyboardbutton</span><span class=p>)</span> <span class=k>do</span> <span class=n>event</span>
    <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>action</span> <span class=o>==</span> <span class=n>Keyboard</span><span class=o>.</span><span class=n>press</span> <span class=o>||</span> <span class=n>event</span><span class=o>.</span><span class=n>action</span> <span class=o>==</span> <span class=n>Keyboard</span><span class=o>.</span><span class=n>repeat</span>
            <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>key</span> <span class=o>==</span> <span class=n>Keyboard</span><span class=o>.</span><span class=n>k</span>
                <span class=n>set_close_to!</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>s</span><span class=o>.</span><span class=n>value</span><span class=p>[]</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span>
            <span class=k>elseif</span> <span class=n>event</span><span class=o>.</span><span class=n>key</span> <span class=o>==</span> <span class=n>Keyboard</span><span class=o>.</span><span class=n>j</span>
                <span class=n>set_close_to!</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>s</span><span class=o>.</span><span class=n>value</span><span class=p>[]</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
            <span class=k>end</span>
        <span class=k>end</span>
    <span class=k>end</span>
    <span class=n>fig</span>
<span class=k>end</span>
</code></pre></div><h1 id=implementing-a-distributed-experiment>Implementing a Distributed Experiment<a hidden class=anchor aria-hidden=true href=#implementing-a-distributed-experiment>#</a></h1>
<p>Writing experiments that spans several nodes is the bread and butter of writing
code in HPC. While it is possible to use libraries such as <code>mpi4py</code> or
<code>libdistributed</code> to write experiments that run on any nodes, Julia provides a
set of libraries that make this nearly effortless, and many of them are part of
the standard library.</p>
<p>In this code you can see:</p>
<ol>
<li>A distributed for loop where communications between nodes were serialized
and abstracted away</li>
<li>The ability to distribute libraries and data to all nodes with the
<code>@everwhere</code> macro</li>
<li>A simple way to store complex metrics to standard formats like CSV even when
not all experiments return the same keys</li>
</ol>
<p>And all of this comes in a mere 36 lines of code.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-julia data-lang=julia><span class=k>using</span> <span class=n>Distributed</span>
<span class=k>using</span> <span class=n>Base</span><span class=o>.</span><span class=n>Iterators</span>
<span class=n>addprocs</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>

<span class=n>template</span> <span class=o>=</span> <span class=kt>Array</span><span class=p>{</span><span class=kt>Float32</span><span class=p>}(</span><span class=nb>undef</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
<span class=n>read!</span><span class=p>(</span><span class=n>expanduser</span><span class=p>(</span><span class=s>&#34;~/git/datasets/hurricane/100x500x500/CLOUDf48.bin.f32&#34;</span><span class=p>),</span> <span class=n>template</span><span class=p>)</span>

<span class=c># broadcast libraries and data to workers</span>
<span class=nd>@everywhere</span> <span class=k>using</span> <span class=n>Pressio</span>
<span class=nd>@everywhere</span> <span class=n>input_data</span> <span class=o>=</span> <span class=o>$</span><span class=n>template</span>
<span class=nd>@everywhere</span> <span class=n>library</span> <span class=o>=</span> <span class=n>pressio</span><span class=p>()</span>

<span class=n>configurations</span> <span class=o>=</span> <span class=n>collect</span><span class=p>((</span><span class=n>product</span><span class=p>([</span><span class=s>&#34;sz&#34;</span><span class=p>,</span> <span class=s>&#34;zfp&#34;</span><span class=p>],</span> <span class=n>exp10</span><span class=o>.</span><span class=p>(</span><span class=n>range</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>6</span><span class=p>,</span> <span class=n>length</span><span class=o>=</span><span class=mi>6</span><span class=p>)))))</span>
<span class=n>results</span> <span class=o>=</span> <span class=nd>@sync</span> <span class=nd>@distributed</span> <span class=n>vcat</span> <span class=k>for</span> <span class=p>(</span><span class=n>comp_id</span><span class=p>,</span> <span class=n>abs</span><span class=p>)</span> <span class=k>in</span> <span class=n>configurations</span>
    <span class=k>try</span>
        <span class=n>comp</span> <span class=o>=</span> <span class=n>compressor</span><span class=p>(</span><span class=n>library</span><span class=p>,</span> <span class=n>comp_id</span><span class=p>)</span>
        <span class=n>options</span> <span class=o>=</span> <span class=kt>Dict</span><span class=p>{</span><span class=kt>String</span><span class=p>,</span><span class=kt>Any</span><span class=p>}(</span>
            <span class=s>&#34;pressio:abs&#34;</span> <span class=o>=&gt;</span> <span class=n>abs</span><span class=p>,</span>
            <span class=s>&#34;pressio:metric&#34;</span> <span class=o>=&gt;</span> <span class=s>&#34;size&#34;</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>set_options</span><span class=p>(</span><span class=n>comp</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
        <span class=n>compress</span><span class=p>(</span><span class=n>comp</span><span class=p>,</span> <span class=n>input_data</span><span class=p>)</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>get_metrics_results</span><span class=p>(</span><span class=n>comp</span><span class=p>)</span>
        <span class=n>result</span><span class=p>[</span><span class=s>&#34;error&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>missing</span>
    <span class=k>catch</span> <span class=n>e</span>
        <span class=n>result</span> <span class=o>=</span> <span class=kt>Dict</span><span class=p>{</span><span class=kt>String</span><span class=p>,</span> <span class=kt>Any</span><span class=p>}()</span>
        <span class=n>result</span><span class=p>[</span><span class=s>&#34;error&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>e</span>
    <span class=k>end</span>
    <span class=n>result</span><span class=p>[</span><span class=s>&#34;comp_id&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>comp_id</span>
    <span class=n>result</span><span class=p>[</span><span class=s>&#34;abs&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>abs</span>
    <span class=p>[</span><span class=n>result</span><span class=p>]</span>
<span class=k>end</span>

<span class=k>using</span> <span class=n>DataFrames</span><span class=p>,</span> <span class=n>Tables</span><span class=p>,</span> <span class=n>CSV</span>
<span class=n>CSV</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s>&#34;/tmp/results.csv&#34;</span><span class=p>,</span> <span class=n>Tables</span><span class=o>.</span><span class=n>dictcolumntable</span><span class=p>(</span><span class=n>results</span><span class=p>),</span>
          <span class=n>transform</span><span class=o>=</span><span class=p>((</span><span class=n>col</span><span class=p>,</span> <span class=n>val</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>something</span><span class=p>(</span><span class=n>val</span><span class=p>,</span> <span class=nb>missing</span><span class=p>)))</span>
</code></pre></div><h1 id=what-are-my-thoughts-since-2019>What Are My Thoughts Since 2019?<a hidden class=anchor aria-hidden=true href=#what-are-my-thoughts-since-2019>#</a></h1>
<p>I largely stand by my 2019 review. The good things about Julia are still good,
and if not have gotten better. While, I still find the matlabisms annoying, I
eventually learned enougth of them to be productive. However, the package
ecosystem has matured substantially in just 2 years with libraries especially
in the areas of language interpop, accllerated computing, and mathmatical
computing are now among best in class, but other areas still are lacking. I
even think discoverablity has improved with podcasts (although mostly on
hiatus) like Talk Julia and the Julia Bloggers and Julia Conn online pressenece
improving knowledge of what is being developed in the Julia community. However
discoverablity of what function to use could still be improved, but has gotten
better with things like LanguageServer.jl.</p>
<p>However, I think 3 things are still largely keeping me from using it more:</p>
<ol>
<li>Reliance on specific Python or C++ libraries. If a project is 90% relying
on a library in some other langauge (i.e. Tensorflow/PyTorch, libfabric) it
sometimes makes sense to just use that language. Finding Julia based
alternatives takes time, and isn&rsquo;t always worth the effort</li>
<li>Lack of knowledge among my colleagues. A big part of my work is sharing my
code with others, and many of my coleagues don&rsquo;t use Julia.</li>
<li>Although for some packages, it has gotten way better, some packages still have
really long pre-compile times (i.e. time to first plot).</li>
</ol>
<p>Hope this helps!</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=http://robertu94.github.io/tags/programming.html>Programming</a></li>
<li><a href=http://robertu94.github.io/tags/julia.html>Julia</a></li>
</ul>
<nav class=paginav>
<a class=prev href=http://robertu94.github.io/2022/12/28/refactoring-with-clang-query.html>
<span class=title>« Prev</span>
<br>
<span>Refactoring With Clang Query</span>
</a>
<a class=next href=http://robertu94.github.io/2022/12/14/debugging-inconsistent-network-performance.html>
<span class=title>Next »</span>
<br>
<span>Debugging Inconsistent Network Performance</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2024 <a href=http://robertu94.github.io/>systems++</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>