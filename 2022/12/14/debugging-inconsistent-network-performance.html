<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Debugging Inconsistent Network Performance | systems++</title>
<meta name=keywords content="networking,debugging">
<meta name=description content="High-performance network interconnects, such as Infiniband, are common in high performance computing environments. Recently, my colleagues, and I ran a series of experiments on the Cooley system at the Argonne Leadership Computing Facility. For one set of experiments, the network performance was consistent and fast, but for the others we periodically had poor performance. Up until this point in my work, I had not directly used or configured network libraries below this layer.">
<meta name=author content="Robert Underwood">
<link rel=canonical href=http://robertu94.github.io/2022/12/14/debugging-inconsistent-network-performance.html>
<meta name=google-site-verification content="G-9KQE44SX6K">
<link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.baa4f2053c75d0009e9309aae8f8a8959f5e0372e88f80cdf2951a9533d71ce2.js integrity="sha256-uqTyBTx10ACekwmq6PiolZ9eA3Loj4DN8pUalTPXHOI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://robertu94.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=http://robertu94.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=http://robertu94.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=http://robertu94.github.io/apple-touch-icon.png>
<link rel=mask-icon href=http://robertu94.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9KQE44SX6K"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-9KQE44SX6K',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Debugging Inconsistent Network Performance">
<meta property="og:description" content="High-performance network interconnects, such as Infiniband, are common in high performance computing environments. Recently, my colleagues, and I ran a series of experiments on the Cooley system at the Argonne Leadership Computing Facility. For one set of experiments, the network performance was consistent and fast, but for the others we periodically had poor performance. Up until this point in my work, I had not directly used or configured network libraries below this layer.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://robertu94.github.io/2022/12/14/debugging-inconsistent-network-performance.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-12-14T00:00:00+00:00">
<meta property="article:modified_time" content="2022-12-14T00:00:00+00:00"><meta property="og:site_name" content="Systems++">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Debugging Inconsistent Network Performance">
<meta name=twitter:description content="High-performance network interconnects, such as Infiniband, are common in high performance computing environments. Recently, my colleagues, and I ran a series of experiments on the Cooley system at the Argonne Leadership Computing Facility. For one set of experiments, the network performance was consistent and fast, but for the others we periodically had poor performance. Up until this point in my work, I had not directly used or configured network libraries below this layer.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Debugging Inconsistent Network Performance","item":"http://robertu94.github.io/2022/12/14/debugging-inconsistent-network-performance.html"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Debugging Inconsistent Network Performance","name":"Debugging Inconsistent Network Performance","description":"High-performance network interconnects, such as Infiniband, are common in high performance computing environments. Recently, my colleagues, and I ran a series of experiments on the Cooley system at the Argonne Leadership Computing Facility. For one set of experiments, the network performance was consistent and fast, but for the others we periodically had poor performance. Up until this point in my work, I had not directly used or configured network libraries below this layer.","keywords":["networking","debugging"],"articleBody":"High-performance network interconnects, such as Infiniband, are common in high performance computing environments. Recently, my colleagues, and I ran a series of experiments on the Cooley system at the Argonne Leadership Computing Facility. For one set of experiments, the network performance was consistent and fast, but for the others we periodically had poor performance. Up until this point in my work, I had not directly used or configured network libraries below this layer. This post summarizes the steps we took to investigate the performance.\nNot knowing what the possible cause was we considered that the input, configuration, software or hardware could be different. As far as we knew, we were providing the same input to both runs. We ran ldd on the associated binaries for each experiment and confirmed that each experiments were loading the same dynamic libraries giving us confidence that it wasn’t the software. Not being super familar with the hardware hardware was on the node. We ran hwloc-ls to see the Node hardware.\n$ hwloc-ls Machine (378GB total) ...... NUMANode L#1 (P#1 189GB) Package L#1 + L3 L#1 (15MB) L2 L#6 (256KB) + L1d L#6 (32KB) + L1i L#6 (32KB) + Core L#6 + PU L#6 (P#6) L2 L#7 (256KB) + L1d L#7 (32KB) + L1i L#7 (32KB) + Core L#7 + PU L#7 (P#7) L2 L#8 (256KB) + L1d L#8 (32KB) + L1i L#8 (32KB) + Core L#8 + PU L#8 (P#8) L2 L#9 (256KB) + L1d L#9 (32KB) + L1i L#9 (32KB) + Core L#9 + PU L#9 (P#9) L2 L#10 (256KB) + L1d L#10 (32KB) + L1i L#10 (32KB) + Core L#10 + PU L#10 (P#10) L2 L#11 (256KB) + L1d L#11 (32KB) + L1i L#11 (32KB) + Core L#11 + PU L#11 (P#11) HostBridge L#7 PCIBridge PCI 15b3:1011 Net L#10 \"ib1\" Net L#11 \"ib0\" OpenFabrics L#12 \"mlx5_0\" PCIBridge PCI 15b3:1003 Net L#13 \"eth2\" OpenFabrics L#14 \"mlx4_0\" The output to our surprise lists two network interfaces: one was an Mellanox version 4 card (mlx4_0) and the other was a Mellanox version 5 (mlx5_0) card. We noted the network device names, and that it one of them was using Ethernet and one was using Infiniband protocol at Layer 2.\nWe then we were curious what devices each of our experiments were configured to use. One set or experiments was using the parallel file system, and the others were using Mochi – a libfabric based networking library. Running mount told us that the experiments using the file system were transiting over the newer card, but we didn’t know what the libfabric library was doing. Libfabric provides some debugging command like fi_info and fi_pingpong. Running fi_info -p verbs we saw both devices were available with the verbs provider, and interestingly the mlx4_0 was returned first. That didn’t mean that our code was necessarily using this interface, but it was a hint. We then printed out the address of the clients and servers as determined by our high level library, and sure enough it was using the mlx4_0 card which we confirmed against the output of ip addr.\nNow this wasn’t enough to declare victory. We next tried to replicate the issue with fi_pingpong -vvv on both client and server, and sure enough when using the mlx4_0 card we saw the same kinds of hangs we did in our experiments. We then tried the same thing with the mlx5_0 card, and we didn’t see any more hangs. We then reconfigured our Mochi based experiments to use ofi+verbs://mlx5_0 to use this card, and sure enough we were able to resolve the issue with hangs.\nHope this helps!\n","wordCount":"598","inLanguage":"en","datePublished":"2022-12-14T00:00:00Z","dateModified":"2022-12-14T00:00:00Z","author":{"@type":"Person","name":"Robert Underwood"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://robertu94.github.io/2022/12/14/debugging-inconsistent-network-performance.html"},"publisher":{"@type":"Organization","name":"systems++","logo":{"@type":"ImageObject","url":"http://robertu94.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=http://robertu94.github.io/ accesskey=h title="systems++ (Alt + H)">systems++</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=http://robertu94.github.io/about.html title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/guides.html title=Guides>
<span>Guides</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/learning.html title="Learning To Learn">
<span>Learning To Learn</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/presentations.html title=Presentations>
<span>Presentations</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=http://robertu94.github.io/>Home</a></div>
<h1 class=post-title>
Debugging Inconsistent Network Performance
</h1>
<div class=post-meta><span title="2022-12-14 00:00:00 +0000 UTC">December 14, 2022</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;598 words&nbsp;·&nbsp;Robert Underwood
</div>
</header>
<div class=post-content><p>High-performance network interconnects, such as Infiniband, are common in high performance computing environments. Recently, my colleagues, and I ran a series of experiments on the Cooley system at the Argonne Leadership Computing Facility. For one set of experiments, the network performance was consistent and fast, but for the others we periodically had poor performance. Up until this point in my work, I had not directly used or configured network libraries below this layer. This post summarizes the steps we took to investigate the performance.</p>
<p>Not knowing what the possible cause was we considered that the input, configuration, software or hardware could be different.
As far as we knew, we were providing the same input to both runs.
We ran <code>ldd</code> on the associated binaries for each experiment and confirmed that each experiments were loading the same dynamic libraries giving us confidence that it wasn&rsquo;t the software.
Not being super familar with the hardware hardware was on the node. We ran <code>hwloc-ls</code> to see the Node hardware.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>hwloc-ls
<span class=go>Machine (378GB total)
</span><span class=go>  ...&lt;snip&gt;...
</span><span class=go>  NUMANode L#1 (P#1 189GB)
</span><span class=go>    Package L#1 + L3 L#1 (15MB)
</span><span class=go>      L2 L#6 (256KB) + L1d L#6 (32KB) + L1i L#6 (32KB) + Core L#6 + PU L#6 (P#6)
</span><span class=go>      L2 L#7 (256KB) + L1d L#7 (32KB) + L1i L#7 (32KB) + Core L#7 + PU L#7 (P#7)
</span><span class=go>      L2 L#8 (256KB) + L1d L#8 (32KB) + L1i L#8 (32KB) + Core L#8 + PU L#8 (P#8)
</span><span class=go>      L2 L#9 (256KB) + L1d L#9 (32KB) + L1i L#9 (32KB) + Core L#9 + PU L#9 (P#9)
</span><span class=go>      L2 L#10 (256KB) + L1d L#10 (32KB) + L1i L#10 (32KB) + Core L#10 + PU L#10 (P#10)
</span><span class=go>      L2 L#11 (256KB) + L1d L#11 (32KB) + L1i L#11 (32KB) + Core L#11 + PU L#11 (P#11)
</span><span class=go>    HostBridge L#7
</span><span class=go>      PCIBridge
</span><span class=go>        PCI 15b3:1011
</span><span class=go>          Net L#10 &#34;ib1&#34;
</span><span class=go>          Net L#11 &#34;ib0&#34;
</span><span class=go>          OpenFabrics L#12 &#34;mlx5_0&#34;
</span><span class=go>      PCIBridge
</span><span class=go>        PCI 15b3:1003
</span><span class=go>          Net L#13 &#34;eth2&#34;
</span><span class=go>          OpenFabrics L#14 &#34;mlx4_0&#34;
</span></code></pre></div><p>The output to our surprise lists two network interfaces: one was an Mellanox version 4 card (<code>mlx4_0</code>) and the other was a Mellanox version 5 (<code>mlx5_0</code>) card. We noted the network device names, and that it one of them was using Ethernet and one was using Infiniband protocol at Layer 2.</p>
<p>We then we were curious what devices each of our experiments were configured to use. One set or experiments was using the parallel file system, and the others were using Mochi &ndash; a libfabric based networking library. Running <code>mount</code> told us that the experiments using the file system were transiting over the newer card, but we didn&rsquo;t know what the libfabric library was doing. Libfabric provides some debugging command like <code>fi_info</code> and <code>fi_pingpong</code>. Running <code>fi_info -p verbs</code> we saw both devices were available with the verbs provider, and interestingly the <code>mlx4_0</code> was returned first. That didn&rsquo;t mean that our code was necessarily using this interface, but it was a hint. We then printed out the address of the clients and servers as determined by our high level library, and sure enough it was using the <code>mlx4_0</code> card which we confirmed against the output of <code>ip addr</code>.</p>
<p>Now this wasn&rsquo;t enough to declare victory. We next tried to replicate the issue with <code>fi_pingpong -vvv</code> on both client and server, and sure enough when using the <code>mlx4_0</code> card we saw the same kinds of hangs we did in our experiments. We then tried the same thing with the <code>mlx5_0</code> card, and we didn&rsquo;t see any more hangs. We then reconfigured our Mochi based experiments to use <code>ofi+verbs://mlx5_0</code> to use this card, and sure enough we were able to resolve the issue with hangs.</p>
<p>Hope this helps!</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=http://robertu94.github.io/tags/networking.html>networking</a></li>
<li><a href=http://robertu94.github.io/tags/debugging.html>debugging</a></li>
</ul>
<nav class=paginav>
<a class=prev href=http://robertu94.github.io/2022/12/15/three-neat-things-i-did-with-julia.html>
<span class=title>« Prev</span>
<br>
<span>Three Neat Things I Did With Julia</span>
</a>
<a class=next href=http://robertu94.github.io/2022/07/20/thoughts-on-dependencies-for-scientific-software.html>
<span class=title>Next »</span>
<br>
<span>Thoughts on Dependencies for Scientific Software</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=http://robertu94.github.io/>systems++</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>