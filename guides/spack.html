<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Shortcut Guide for Configuring Spack for a New HPC System | systems++</title>
<meta name=keywords content>
<meta name=description content="Setting up spack The way that I use spack, there are 6 major steps to configuring spack:
 Determine what system compiler, python, and MPI you will use Telling spack how to find your compiler Telling spack find major system dependencies such as MPI and OpenSSL as external dependencies Configuring preferred providers for virtual dependencies and target architectures Configuring spack to use a binary cache if it will matter Setting up a shell shortcut for loading spack  What system dependencies to use Spack does a pretty good job &ldquo;living off the land&rdquo; using what ever dependencies you may need.">
<meta name=author content="Robert Underwood">
<link rel=canonical href=http://robertu94.github.io/guides/spack.html>
<meta name=google-site-verification content="G-9KQE44SX6K">
<link crossorigin=anonymous href=/assets/css/stylesheet.57f29198e62b3a8f07d37acaca0427bafb684416046b823f5a616bd858bb4af1.css integrity="sha256-V/KRmOYrOo8H03rKygQnuvtoRBYEa4I/WmFr2Fi7SvE=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.baa4f2053c75d0009e9309aae8f8a8959f5e0372e88f80cdf2951a9533d71ce2.js integrity="sha256-uqTyBTx10ACekwmq6PiolZ9eA3Loj4DN8pUalTPXHOI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://robertu94.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=http://robertu94.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=http://robertu94.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=http://robertu94.github.io/apple-touch-icon.png>
<link rel=mask-icon href=http://robertu94.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9KQE44SX6K"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-9KQE44SX6K',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Shortcut Guide for Configuring Spack for a New HPC System">
<meta property="og:description" content="Setting up spack The way that I use spack, there are 6 major steps to configuring spack:
 Determine what system compiler, python, and MPI you will use Telling spack how to find your compiler Telling spack find major system dependencies such as MPI and OpenSSL as external dependencies Configuring preferred providers for virtual dependencies and target architectures Configuring spack to use a binary cache if it will matter Setting up a shell shortcut for loading spack  What system dependencies to use Spack does a pretty good job &ldquo;living off the land&rdquo; using what ever dependencies you may need.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://robertu94.github.io/guides/spack.html"><meta property="article:section" content="guides">
<meta property="article:published_time" content="2022-07-19T00:00:00+00:00">
<meta property="article:modified_time" content="2022-07-19T00:00:00+00:00"><meta property="og:site_name" content="Systems++">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Shortcut Guide for Configuring Spack for a New HPC System">
<meta name=twitter:description content="Setting up spack The way that I use spack, there are 6 major steps to configuring spack:
 Determine what system compiler, python, and MPI you will use Telling spack how to find your compiler Telling spack find major system dependencies such as MPI and OpenSSL as external dependencies Configuring preferred providers for virtual dependencies and target architectures Configuring spack to use a binary cache if it will matter Setting up a shell shortcut for loading spack  What system dependencies to use Spack does a pretty good job &ldquo;living off the land&rdquo; using what ever dependencies you may need.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Shortcut Guide for Configuring Spack for a New HPC System","item":"http://robertu94.github.io/guides/spack.html"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Shortcut Guide for Configuring Spack for a New HPC System","name":"Shortcut Guide for Configuring Spack for a New HPC System","description":"Setting up spack The way that I use spack, there are 6 major steps to configuring spack:\n Determine what system compiler, python, and MPI you will use Telling spack how to find your compiler Telling spack find major system dependencies such as MPI and OpenSSL as external dependencies Configuring preferred providers for virtual dependencies and target architectures Configuring spack to use a binary cache if it will matter Setting up a shell shortcut for loading spack  What system dependencies to use Spack does a pretty good job \u0026ldquo;living off the land\u0026rdquo; using what ever dependencies you may need.","keywords":[],"articleBody":"Setting up spack The way that I use spack, there are 6 major steps to configuring spack:\n Determine what system compiler, python, and MPI you will use Telling spack how to find your compiler Telling spack find major system dependencies such as MPI and OpenSSL as external dependencies Configuring preferred providers for virtual dependencies and target architectures Configuring spack to use a binary cache if it will matter Setting up a shell shortcut for loading spack  What system dependencies to use Spack does a pretty good job “living off the land” using what ever dependencies you may need. There are a few packages that benefit from just using the versions provided by your system administrator typically your compilers, python (used to invoke spack; not the one you intend to use), MPI, and OpenSSL.\nCompilers and Python are hard dependencies of spack, and it can’t be used without them. You probably want to grab a somewhat recent compiler if it is available to you. Spack can install compilers for you, but they often take a long time to compile so reusing a prebuilt compiler if possible is really nice.\nMPI is special both because it often has to be paired with a specific compiler version to work correctly, but also because MPI implementations has so many variants and options, it can be difficult to configure correctly. Using the system MPI hopefully ensures you get the right one.\nOpenSSL is also special because spack itself needs a working OpenSSL to do many thing involving downloading packages, and using a non-standard OpenSSL will break commands like curl and git. You can work around this, but it is often best to just use the system version of this package\nConfiguring the spack compiler If a module is needed for your compiler load that first.\nAfter that, Spack’s built-in spack compiler find command does most of what you will want. However there is one nuance is that won’t correctly determine what modules it should load.\nIf you determined you need a compiler provided by a module, you need to tell spack about that now using the module entry in spack.\nConfiguring Major Dependencies If a module is required for your MPI module, load that first.\nAfter that Spack’s built-in spack external find $spack_name_for_mpi_version will do what you want for MPI. Likewise spack external find openssl will handle OpenSSL.\nIf you determined you need a MPI provided by a module, you need to tell spack about that now using the module entry in spack.\nConfiguring Preferred Variants and Targets Some hardware will have hardware optimized libraries or prefered configurations. Set these now in the all packages variants section of package.yaml.\nOn heterogeneous clusters, setting target= to your common CPU hardware architecture can vastly simplify deployment at modest performance cost. Alternatively, provide a list of architectures to cross compile as needed.\nConfiguring spack to use a binary cache Some systems (mainly LTS Ubuntu) have binary caches pre-built for spack that can vastly improve install times for common packages builtin in common ways. For Ubuntu 18.04 this works wonders to decrease build times:\nspack mirror add binary_mirror https://binaries.spack.io/releases/v0.18 spack buildcache keys --install --trust The other popular cache is e4s which supports a newer ubuntu LTS release, and some other distros provided you are willing to build your own compiler.\nspack mirror add E4S https://cache.e4s.io spack buildcache keys --install --trust Setting up a shell shortcut I like to have a single command to load spack and any MPI or compiler modules that I may need which I often call use build.\nSetting LD_LIBRARY_PATH when it is needed If you have a spack envionment where you need LD_LIBRARY_PATH (e.g. to build or run with a Makfile). Then you can use the following commands to have spack add these variables, run despacktivate and then sspack env activate /path/to/env to reactivate it.\nspack config add modules:prefix_inspections:lib:[LD_LIBRARY_PATH] spack config add modules:prefix_inspections:lib64:[LD_LIBRARY_PATH] Updating Spack I generally recommend rebuilding your spack envirionments whenever you update spack’s major version or whenever there is a major change to your HPC system (new modules for core dependencies, new OS version, new hardware). Because with spack environments re-building a specific environment is easy, I often do this by rm -rf spack and re-building from scratch.\nI find that more incremental updates can be more buggy than they are worth.\nChangelog  2022-07-19 created this document  ","wordCount":"725","inLanguage":"en","datePublished":"2022-07-19T00:00:00Z","dateModified":"2022-07-19T00:00:00Z","author":{"@type":"Person","name":"Robert Underwood"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://robertu94.github.io/guides/spack.html"},"publisher":{"@type":"Organization","name":"systems++","logo":{"@type":"ImageObject","url":"http://robertu94.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=http://robertu94.github.io/ accesskey=h title="systems++ (Alt + H)">systems++</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=http://robertu94.github.io/about.html title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/guides.html title=Guides>
<span>Guides</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/learning.html title="Learning To Learn">
<span>Learning To Learn</span>
</a>
</li>
<li>
<a href=http://robertu94.github.io/presentations.html title=Presentations>
<span>Presentations</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=http://robertu94.github.io/>Home</a></div>
<h1 class=post-title>
Shortcut Guide for Configuring Spack for a New HPC System
</h1>
<div class=post-meta><span title="2022-07-19 00:00:00 +0000 UTC">July 19, 2022</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;725 words&nbsp;·&nbsp;Robert Underwood
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><nav id=TableOfContents>
<ul>
<li><a href=#setting-up-spack>Setting up spack</a>
<ul>
<li><a href=#what-system-dependencies-to-use>What system dependencies to use</a></li>
<li><a href=#configuring-the-spack-compiler>Configuring the spack compiler</a></li>
<li><a href=#configuring-major-dependencies>Configuring Major Dependencies</a></li>
<li><a href=#configuring-preferred-variants-and-targets>Configuring Preferred Variants and Targets</a></li>
<li><a href=#configuring-spack-to-use-a-binary-cache>Configuring spack to use a binary cache</a></li>
<li><a href=#setting-up-a-shell-shortcut>Setting up a shell shortcut</a></li>
<li><a href=#setting-ld_library_path-when-it-is-needed>Setting LD_LIBRARY_PATH when it is needed</a></li>
</ul>
</li>
<li><a href=#updating-spack>Updating Spack</a></li>
<li><a href=#changelog>Changelog</a></li>
</ul>
</nav>
</div>
</details>
</div>
<div class=post-content><h1 id=setting-up-spack>Setting up spack<a hidden class=anchor aria-hidden=true href=#setting-up-spack>#</a></h1>
<p>The way that I use spack, there are 6 major steps to configuring spack:</p>
<ol>
<li>Determine what system compiler, python, and MPI you will use</li>
<li>Telling spack how to find your compiler</li>
<li>Telling spack find major system dependencies such as MPI and OpenSSL as external dependencies</li>
<li>Configuring preferred providers for virtual dependencies and target architectures</li>
<li>Configuring spack to use a binary cache if it will matter</li>
<li>Setting up a shell shortcut for loading spack</li>
</ol>
<h2 id=what-system-dependencies-to-use>What system dependencies to use<a hidden class=anchor aria-hidden=true href=#what-system-dependencies-to-use>#</a></h2>
<p>Spack does a pretty good job &ldquo;living off the land&rdquo; using what ever dependencies you may need.
There are a few packages that benefit from just using the versions provided by your system
administrator typically your compilers, python (used to invoke spack; not the one you intend to use),
MPI, and OpenSSL.</p>
<p>Compilers and Python are hard dependencies of spack, and it can&rsquo;t be used without them. You
probably want to grab a somewhat recent compiler if it is available to you. Spack can install
compilers for you, but they often take a long time to compile so reusing a prebuilt compiler if
possible is really nice.</p>
<p>MPI is special both because it often has to be paired with a specific compiler version to work
correctly, but also because MPI implementations has so many variants and options, it can be
difficult to configure correctly. Using the system MPI hopefully ensures you get the right one.</p>
<p>OpenSSL is also special because spack itself needs a working OpenSSL to do many thing involving
downloading packages, and using a non-standard OpenSSL will break commands like <code>curl</code> and <code>git</code>.
You can work around this, but it is often best to just use the system version of this package</p>
<h2 id=configuring-the-spack-compiler>Configuring the spack compiler<a hidden class=anchor aria-hidden=true href=#configuring-the-spack-compiler>#</a></h2>
<p>If a module is needed for your compiler load that first.</p>
<p>After that, Spack&rsquo;s built-in <code>spack compiler find</code> command does most of what you will want. However
there is one nuance is that won&rsquo;t correctly determine what modules it should load.</p>
<p>If you determined you need a compiler provided by a module, you need to tell spack about that now
using the <code>module</code> entry in spack.</p>
<h2 id=configuring-major-dependencies>Configuring Major Dependencies<a hidden class=anchor aria-hidden=true href=#configuring-major-dependencies>#</a></h2>
<p>If a module is required for your MPI module, load that first.</p>
<p>After that Spack&rsquo;s built-in <code>spack external find $spack_name_for_mpi_version</code> will do what you want
for MPI. Likewise <code>spack external find openssl</code> will handle OpenSSL.</p>
<p>If you determined you need a MPI provided by a module, you need to tell spack about that now
using the <code>module</code> entry in spack.</p>
<h2 id=configuring-preferred-variants-and-targets>Configuring Preferred Variants and Targets<a hidden class=anchor aria-hidden=true href=#configuring-preferred-variants-and-targets>#</a></h2>
<p>Some hardware will have hardware optimized libraries or prefered configurations. Set these now in
the <code>all</code> packages variants section of <code>package.yaml</code>.</p>
<p>On heterogeneous clusters, setting <code>target=</code> to your common CPU hardware architecture can vastly
simplify deployment at modest performance cost. Alternatively, provide a list of architectures to
cross compile as needed.</p>
<h2 id=configuring-spack-to-use-a-binary-cache>Configuring spack to use a binary cache<a hidden class=anchor aria-hidden=true href=#configuring-spack-to-use-a-binary-cache>#</a></h2>
<p>Some systems (mainly LTS Ubuntu) have binary caches pre-built for spack that can vastly improve
install times for common packages builtin in common ways. For Ubuntu 18.04 this works wonders to
decrease build times:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>spack mirror add binary_mirror  https://binaries.spack.io/releases/v0.18
spack buildcache keys --install --trust
</code></pre></div><p>The other popular cache is e4s which supports a newer ubuntu LTS release, and some other distros
provided you are willing to build your own compiler.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>spack mirror add E4S https://cache.e4s.io
spack buildcache keys --install --trust
</code></pre></div><h2 id=setting-up-a-shell-shortcut>Setting up a shell shortcut<a hidden class=anchor aria-hidden=true href=#setting-up-a-shell-shortcut>#</a></h2>
<p>I like to have a single command to load spack and any MPI or compiler modules that I may need which
I often call use build.</p>
<h2 id=setting-ld_library_path-when-it-is-needed>Setting LD_LIBRARY_PATH when it is needed<a hidden class=anchor aria-hidden=true href=#setting-ld_library_path-when-it-is-needed>#</a></h2>
<p>If you have a spack envionment where you need LD_LIBRARY_PATH (e.g. to build or run with a Makfile).
Then you can use the following commands to have spack add these variables, run <code>despacktivate</code> and then <code>sspack env activate /path/to/env</code> to reactivate it.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>spack config add modules:prefix_inspections:lib:<span class=o>[</span>LD_LIBRARY_PATH<span class=o>]</span>
spack config add modules:prefix_inspections:lib64:<span class=o>[</span>LD_LIBRARY_PATH<span class=o>]</span>
</code></pre></div><h1 id=updating-spack>Updating Spack<a hidden class=anchor aria-hidden=true href=#updating-spack>#</a></h1>
<p>I generally recommend rebuilding your spack envirionments whenever you update spack&rsquo;s major version
or whenever there is a major change to your HPC system (new modules for core dependencies, new OS
version, new hardware). Because with spack environments re-building a specific environment is easy,
I often do this by <code>rm -rf spack</code> and re-building from scratch.</p>
<p>I find that more incremental updates can be more buggy than they are worth.</p>
<h1 id=changelog>Changelog<a hidden class=anchor aria-hidden=true href=#changelog>#</a></h1>
<ul>
<li>2022-07-19 created this document</li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2024 <a href=http://robertu94.github.io/>systems++</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>